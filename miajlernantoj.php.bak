<?
include "lingvo.inc.php";
include "db.inc.php";
include "webui.inc.php";
include "forum/includes/forum.lib.php";
include_once("db/nuna_kurso.inc.php");
malfermiDatumbazon();
$persono_id=$_SESSION["persono_id"];
if ($persono_id=="") {header("Location:index.php?erarkodo=8");}
$persono = apartigiPersonon($persono_id);
if (($persono["rajtoj"]!='A')&&($persono["rajtoj"]!='K')) {header("Location:index.php?erarkodo=4");}
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Pragma: no-cache"); // HTTP/1.0

// tiu funkcio konstruas la liston de cxiuj studantoj
function listiStudantojn() {
	global $lingvo,$persono_id,$lgv_nekomencita,$lgv_neniuLernanto,$lgv_nuna_leciono,$lgv_ek,$idnoto,$lgv_sekvitakurso,$lgv_haltita,$lgv_finita;
	$i=0;
	// studantoj kiu NE jam komencis lerni (stato de nuna_kurso valoras 'N' kiel NE komencita)
	$demando = "select nuna_kurso.id as kursid,nuna_kurso.studanto as studanto,nuna_kurso.lastdato,(TO_DAYS(NOW()) - TO_DAYS(nuna_kurso.lastdato)) as numtagoj1,nuna_kurso.ekdato,(TO_DAYS(NOW()) - TO_DAYS(nuna_kurso.ekdato)) as numtagoj2, personoj.enirnomo,personoj.personnomo,personoj.familinomo,personoj.naskigxdato as naskigxdato,personoj.retadreso as retadreso,personoj.adreso1 as adreso1,personoj.adreso2 as adreso2,personoj.lando as lando,personoj.posxtkodo as posxtkodo,personoj.urbo as urbo,personoj.kialo as kialo,personoj.noto as noto,nuna_kurso.nunleciono,nuna_kurso.kurso as kurso from personoj,nuna_kurso where nuna_kurso.studanto=personoj.id and nuna_kurso.korektanto=$persono_id and (nuna_kurso.stato='K' or nuna_kurso.stato='N')";
	mysql_select_db( "ikurso");
	$result = mysql_query($demando) or die (  "SELECT : malbona demando :".$demando);
	while($row = mysql_fetch_array($result)) {		
		echo "<table width=\"95%\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"";
		echo "background=\"bildoj/";
		($row['numtagoj1']==NULL)?($numtagoj=$row['numtagoj2']):($numtagoj=$row['numtagoj1']);
		if ($numtagoj<11) {echo "bandeau-vert.gif";}
		elseif ($numtagoj<31) {echo "bandeau-orange.gif";}
		else {echo "bandeau-rouge.gif";}
		echo"\"><tr>";
		echo "<td width=\"35\" align=\"center\" class=\"dika\">".$numtagoj."</span></td>\n";
		echo "<td class=\"dika\"><img src=\"bildoj/";
		if ($row["kurso"]=="KE") {echo "ikurso-ikono.gif\"";}
		if ($row["kurso"]=="CG") {echo "cge-ikono.gif\"";}
		if ($row["kurso"]=="GR") {echo "gerda-ikono.gif\"";}
		echo "\" align=\"middle\">";
		echo "\n&nbsp;&nbsp;".$row["enirnomo"]." (".$row['personnomo']." ".$row['familinomo'].") - ";
		echo "<a href=\"mailto:".$row['retadreso']."\">".$row["retadreso"]."</a>\n";
 		echo "</td>\n</tr>\n";
		echo "</table><table width=\"95%\" align=\"center\" border=\"1\" cellpadding=\"5\" cellspacing=\"0\">\n";
		echo "<tr>\n";
		// colonne 1: coordonnees 
		echo "<td class=\"normala\" valign=\"top\" nowrap><span class=\"fajna\">n&eacute;(e) le </span>";
		ereg("([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})", $row["naskigxdato"],$nskdt);
		echo $nskdt[3]."/".$nskdt[2]."/".$nskdt[1]."<br>";
		if ($row["adreso1"]!="") echo $row["adreso1"]."<br>";
		if ($row["adreso2"]!="") echo $row["adreso2"]."<br>";
		echo $row["posxtkodo"]." ".$row["urbo"]."<br>";
		echo $row["lando"]."-";
			
		// colonne 3: cours suivi
		echo "</td>\n<td width=30% class=\"normala\" valign=\"top\" nowrap>";
		$demando2="select kursoj.nomo as kursnomo from kursoj where kursoj.kodo='".$row['kurso']."' and kursoj.lingvo='$lingvo'"; 
		mysql_select_db( "ikurso");
		$result2 = mysql_query($demando2) or die (  "SELECT : malbona demando :".$demando2);
		$row2 = mysql_fetch_array($result2);
		echo "<form method=\"POST\" action=\"miajlernantoj2.php\">"; 
		echo $row2["kursnomo"]."<br>";	
		echo "<span class=\"fajna\">inscription le : </span>\n";
		ereg("([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})", $row["ekdato"],$ekdt);
		echo $ekdt[3]."/".$ekdt[2]."/".$ekdt[1]."<br>\n";
		echo "<span class=\"fajna\">derni&egrave;re le&ccedil;on envoy&eacute;e le : </span>\n";
		if ($row["lastdato"]==0) {
			echo "--/--/--<br>\n";
		}
		else{
			ereg("([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})", $row["lastdato"],$lstdt);
			echo $lstdt[3]."/".$lstdt[2]."/".$lstdt[1]."<br>\n";
		}
		echo "<select name=\"leciono\">\n";
		echo "<option value=\"".$row["kursid"]."-N\" >".$lgv_nekomencita."</option>\n";
		$demando3="select lecionoj.titolo, lecionoj.numero from lecionoj where lecionoj.kurso='".$row["kurso"]."' and lecionoj.lingvo='$lingvo'";
		$result3 = mysql_query($demando3) or die (  "INSERT : malbona demando :".$demando3);
		while($row3 = mysql_fetch_array($result3)) {
			// echo $lgv_nuna_leciono." : ".$row3["titolo"]."-".$row3["numero"]."<br>\n";	
			echo "<option value=\"".$row["kursid"]."-".$row3["numero"]."\" ";
			if ($row["nunleciono"]==$row3["numero"]) {echo "selected";}
				echo ">".$row3["titolo"]."</option>\n";
		}
		echo "<option value=\"".$row["kursid"]."-H\" >".$lgv_haltita."</option>\n";
		echo "<option value=\"".$row["kursid"]."-F\" >".$lgv_finita."</option>\n";
		echo "</select>\n";
		echo "<input type=\"hidden\" name=\"nunleciono\" value=\"".$row["nunleciono"]."\">";
		echo "<input type=\"submit\" value=\"".$lgv_ek."\">";
		echo "</form>\n";

		// colonne 3: commentaires
		echo "</td>\n<td width=50% class=\"normala\" valign=\"top\">";
		echo "<span class=\"fajna\">commentaire de l'&eacute;l&egrave;ve :</span><br>";
		echo "<span style=\"color:#808080\">".stripslashes($row['kialo'])."</span><br>";
		echo "<span class=\"fajna\">commentaires du correcteur :<br>";
		// notoj aldoneblaj per la korektanto
		$demando4 = "select * from komentoj where komentoj.studanto='".$row["studanto"]."'";
		$result4 = mysql_query($demando4) or die (  "SELECT : malbona demando :".$demando4);
		echo "<span class='normala'>";
		while ($row4 = mysql_fetch_array($result4)){
			$demando5 = "select enirnomo from personoj where personoj.id='".$row4['korektanto']."'";
			$result5 = mysql_query($demando5) or die (  "SELECT : malbona demando :".$demando5);
			$row5 = mysql_fetch_array($result5);
			if ($row4["korektanto"]==$persono_id){
				echo "<a href='forigiNoton.php?noto_id=".$row4['id']."&stud_id=".$row['studanto']."&stud_nomo=".$row['enirnomo']."&pagxo=miajlernantoj.php'>";
				echo "<img src=\"forum/templates/subSilver/images/icon_delete.gif\" alt=\"Supprimer ce commentaire\" title=\"Supprimer ce commentaire\" border=\"0\" align=\"middle\"></a>";
			}
			echo " <span class='fajna' style=\"color:gray\">de ".$row5['enirnomo']." le ".$row4['dato']."</span> :\n";
			echo "<span class='normala'>\n";
			echo " ".$row4["teksto"]."\n";
			echo "</span><br>\n";
		}	
		echo "<form name='aldoniNoton".$i."' method='post' action='aldoniNoton.php'>\n";
		echo "<input type='hidden' name='stud_id' value='".$row["studanto"]."'>\n";
		echo "<input type='hidden' name='pagxo' value='miajlernantoj.php'>";
		echo "<input type='text' name='teksto' size='50' value='** vous pouvez ajouter un commentaire ici **' onFocus='this.value=\"\"'>";
		echo "&nbsp;&nbsp;<input type='image' src='bildoj/icon_valider2.gif' align='middle' onClick='this.form.submit();'>";
		echo "</form>";
		echo "</span>";
		echo "</td></tr>";     
		$i++;
	}
	if ($i==0) { echo "<tr><td>".$lgv_neniuLernanto."</td></tr>";}
	echo "</table>";
}
function kalkuliStudantojn() {
	global $lingvo,$persono_id;
	$demando1="select nomo,kodo from kursoj where kursoj.lingvo='".$lingvo."'";
	$result1 = mysql_query($demando1) or die (  "SELECT : malbona demando :".$demando1);
	while($row1 = mysql_fetch_array($result1)) {
		echo "<tr class=\"normala\">\n";
		echo "\t<td>".$row1["nomo"]."</td>\n";
		$demando2="select count(*) as kiom from nuna_kurso,personoj where nuna_kurso.korektanto='".$persono_id."' and nuna_kurso.kurso='".$row1["kodo"]."' and personoj.id=nuna_kurso.studanto and (nuna_kurso.stato='K' or nuna_kurso.stato='N')";
		$result2 = mysql_query($demando2) or die (  "SELECT : malbona demando :".$demando2);
		$row2 = mysql_fetch_array($result2);
		echo "\t<td align=\"center\">".$row2['kiom']."</td>\n";
		$demando3="select * from korektebla_kurso where korektanto='".$persono_id."' and kurso='".$row1['kodo']."'";
		$result3 = mysql_query($demando3) or die ("SELECT : malbona demando :".$demando3);
		if (mysql_num_rows($result3)==0){
			$demando3="INSERT INTO korektebla_kurso (korektanto,kurso,kiom_lernantoj) VALUES ('$persono_id','".$row1["kodo"]."',0)";
			$result3 = mysql_query($demando3) or die ("INSERT : Invalid query :".$demando3);
			$demando3="select * from korektebla_kurso where korektanto='".$persono_id."' and kurso='".$row1['kodo']."'";
			$result3 = mysql_query($demando3) or die (  "SELECT : malbona demando :".$demando3);
		}
		$row3 = mysql_fetch_array($result3);
		echo "\t<td align=\"center\">";
		if ($row2['kiom'] > $row3["kiom_lernantoj"]) {
			echo "<span style=\"color:red\">".$row3["kiom_lernantoj"]."</span>";
		}else {echo $row3["kiom_lernantoj"];}
		echo "</td>\n";
		echo "\t</tr>\n";
	}
}
?>
<html>
<head>
<title>ikurso - Mes &eacute;l&egrave;ves</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" <? if ($validi=="jes") { echo "onLoad=\"window.alert('".$lgv_datumsavo."');\""; } ?>>
<?
	pagxkapo();
	menuo($persono["enirnomo"],$persono["rajtoj"]);
?>
<center>
  <table border="0" cellspacing="0" cellpadding="0" width="100%">
	  <tr>
		  <td nowrap>
		  <div align="center" class="titolo"><? echo $lgv_miajlernantoj; ?></div>
		  </td>
		  <td>&nbsp;</td>
		</tr>
		<tr>
		<!-- table du nb d'eleves par cours et du nb maximum demande -->
			<td align="center">
				<form name="NBlernantoj" method="POST">
				<table border="1" cellpadding="2">
					<tr class="fajna" align="center">
						<td>cours</td>
						<td>&eacute;l&egrave;ves<br>en cours</td>
						<td>nombre<br>maximum</td>
					</tr>
					<? kalkuliStudantojn(); ?>
				</table>
				<!--			
				<input type="hidden" name="tkursoj" value="$tkursoj">
				-->
				<p class="fajna" align="center">
				Cliquez ici pour 
				<a href="#" onClick="window.open('sxangxiNBlernantoj.php','', 'resizable=no,scrollbars=no,location=no,top=200,left=200,width=450,height=250');">
				modifier le nombre d'&eacute;l&egrave;ves</a> que vous souhaitez suivre</p>
				</form>
			</td>
			<td width="20%">
				<p class="dika" align="center" style="color:red"><i>NOUVEAU !</i></p>
				<p class="normala" style="color:blue">Cette page remplace les anciennes pages "G&eacute;rer ses &eacute;l&egrave;ves"<br>
				et "Liste des &eacute;l&egrave;ves".<br>
				Pour plus d'informations, voir le <a href="helppagxo.php">Guide du correcteur</a>.
				</p>
			</td>
		<tr>
	    <td colspan="3">
	    <? listiStudantojn(); ?>
</center>
</body>
</html>                  